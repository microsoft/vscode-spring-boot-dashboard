variables:
  Codeql.Enabled: true

schedules:
- cron: 0 0 * * *
  branches:
    include:
    - refs/heads/main

jobs:
- job: Job_1
  displayName: Build
  pool:
    vmImage: ubuntu-latest
  steps:
  - checkout: self
    fetchTags: false
  - task: NodeTool@0
    displayName: Use Node 10.x
    enabled: False
    inputs:
      versionSpec: 10.x
  - task: Npm@1
    displayName: npm install
    inputs:
      verbose: false
  - task: Npm@1
    displayName: npm run tslint
    inputs:
      command: custom
      verbose: false
      customCommand: run tslint
  - task: Npm@1
    displayName: npm run compile
    inputs:
      command: custom
      verbose: false
      customCommand: run compile
  - task: CmdLine@2
    displayName: Replace AI Key
    inputs:
      script: npx json@9.0.6 -I -f package.json -e "this.aiKey=\"$AI_KEY\""
  - bash: |
      npx json@latest -I -f package.json -e "this.version=this.version.substring(0, this.version.lastIndexOf('.'))+\".$(date -u +'%Y%m%d%H')\""
    displayName: Update patch version in package.json
  - task: EsrpCodeSigning@1
    displayName: ESRP CodeSigning
    enabled: False
    inputs:
      ConnectedServiceName: d5f51b85-6feb-48f6-a077-37426b5911f4
      FolderPath: lib
      Pattern: '*.jar'
      signConfigType: inlineSignParams
      inlineOperation: >-
        [
                {
                    "KeyCode" : "CP-447347-Java",
                    "OperationCode" : "JavaSign",
                    "Parameters" : {
                        "SigAlg" : "SHA256withRSA",
                        "Timestamp" : "-tsa http://sha256timestamp.ws.digicert.com/sha256/timestamp"
                    },
                    "ToolName" : "sign",
                    "ToolVersion" : "1.0"
                },
                {
                    "KeyCode" : "CP-447347-Java",
                    "OperationCode" : "JavaVerify",
                    "Parameters" : {},
                    "ToolName" : "sign",
                    "ToolVersion" : "1.0"
                }
        ]
  - task: CmdLine@2
    displayName: VSCE package --pre-release
    inputs:
      script: npx vsce@latest package --pre-release
  - task: Npm@1
    displayName: npm run test
    enabled: False
    inputs:
      command: custom
      verbose: false
      customCommand: run test
  - task: CopyFiles@2
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
    inputs:
      Contents: '*.vsix'
      TargetFolder: $(Build.ArtifactStagingDirectory)
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: drop'
...
